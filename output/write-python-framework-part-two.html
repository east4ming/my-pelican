<!DOCTYPE html>
<html lang="zh_cn">
<head>
        <meta charset="utf-8" />
        <title>如何编写Python Web框架（二）</title>
        <link rel="stylesheet" href="./theme/css/main.css" />
</head>

<body id="index" class="home">
<a href="https://github.com/east4ming">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="./">东风微鸣 Blog <strong>Focus on Python/Java/DevOps/Observability</strong></a></h1>
                <nav><ul>
                    <li class="active"><a href="./category/python.html">python</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./write-python-framework-part-two.html" rel="bookmark"
           title="Permalink to 如何编写Python Web框架（二）">如何编写Python Web框架（二）</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-03-01T15:51:00+08:00">
                Published: 2019-03-01 Friday
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="./author/dong-feng-wei-ming.html">东风微鸣</a>
        </address>
<p>In <a href="./category/python.html">python</a>.</p>
<p>tags: <a href="./tag/python.html">python</a> <a href="./tag/webkuang-jia.html">web框架</a> </p>
</footer><!-- /.post-info -->      <p><img alt="" src="./images/Python-Web-Development-Tutorials.jpg"></p>
<h1 id="python-web"><a class="toclink" href="#python-web">如何编写Python Web框架（二）</a><a class="headerlink" href="#python-web" title="Permanent link">&para;</a></h1>
<blockquote>
<p>本文为译文</p>
<p>原文链接: <a href="http://rahmonov.me/posts/write-python-framework-part-two/">How to write a Python web framework. Part II.</a></p>
<p>作者: Jahongir Rahmonov</p>
<p>Github仓库: <a href="https://github.com/rahmonov/alcazar">alcazar</a></p>
</blockquote>
<p>在<a href="./write-python-framework-part-one.html">第一部分中</a>，我们开始编写自己的Python框架并实现以下功能：</p>
<ul>
<li>WSGI兼容</li>
<li>请求处理程序</li>
<li>路由：简单和参数化</li>
</ul>
<p>请务必在此之前阅读系列的<a href="./write-python-framework-part-one.html">第一部分</a>。</p>
<p>这部分同样令人兴奋，我们将在其中添加以下功能：</p>
<ul>
<li>检查重复的路径</li>
<li>基于类的处理程序</li>
<li>单元测试</li>
</ul>
<p>Ready? 让我们开始吧。</p>
<h2 id="_1"><a class="toclink" href="#_1">重复的路径</a><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>现在，我们的框架允许添加任意次数相同的路由。因此，以下内容将起作用：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Hello from the HOME page&quot;</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home2</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Hello from the SECOND HOME page&quot;</span>
</pre></div>
</td></tr></table>

<p>框架不会抱怨，因为我们使用Python字典来存储路由，只有最后一个才能使用<code>http://localhost:8000/home/</code>。显然，这并不好。我们希望确保框架在用户尝试添加现有路由时会抛出信息。您可以想象，实施起来并不是很困难。因为我们使用Python dict来存储路由，所以我们可以简单地检查字典中是否已存在给定路径。如果是，我们抛出异常，如果不是，我们让它添加一个路由。在我们编写任何代码之前，让我们回忆下我们的主要<code>API</code>类：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">class</span> <span class="nc">API</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="k">return</span> <span class="n">handler</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parse_result</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">request_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parse_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">handler</span><span class="p">,</span> <span class="n">parse_result</span><span class="o">.</span><span class="n">named</span>

        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

        <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">default_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Not found.&quot;</span>
</pre></div>
</td></tr></table>

<p>我们需要更改<code>route</code>函数，以便在再次添加现有路由时抛出异常：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Such route already exists.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="k">return</span> <span class="n">handler</span>

    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</td></tr></table>

<p>现在，尝试添加相同的路径两次并重新启动你的gunicorn。您应该看到抛出以下异常：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>Traceback (most recent call last):
...
AssertionError: Such route already exists.
</pre></div>
</td></tr></table>

<p>我们可以重构它以将其减少到一行：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">routes</span><span class="p">,</span> <span class="s2">&quot;Such route already exists.&quot;</span>

    <span class="o">...</span>
</pre></div>
</td></tr></table>

<p>完工！进入下一个功能。</p>
<h2 id="_2"><a class="toclink" href="#_2">基于类的处理程序</a><a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>如果你了解Django，你知道它支持基于函数和基于类的视图（即我们的处理程序）。我们已经有了基于函数的处理程序。现在我们将添加基于类的，适用于更复杂, 更大的处理程序。我们基于类的处理程序将如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app.py</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/book&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BooksHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Books Page&quot;</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Endpoint to create a book&quot;</span>

    <span class="o">...</span>
</pre></div>
</td></tr></table>

<p>这意味着我们存储路径的dict:  <code>self.routes</code>可以包含类和函数作为值。因此，当我们在<code>handle_request()</code>方法中找到一个处理程序时，我们需要检查处理程序是一个函数还是一个类。如果它是一个函数，它应该像现在一样工作。如果它是一个类，根据请求方法，我们应该调用该类的对应方法。也就是说，如果请求方法是<code>GET</code>，我们应该调用类的<code>get()</code>方法，如果是<code>POST</code>我们应该调用<code>post</code>方法等。这是<code>handle_request()</code>方法现在的样子：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

    <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table>

<p>我们要做的第一件事是检查找到的处理程序是否是一个类。为此，我们使用<code>inspect</code>模块：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="kn">import</span> <span class="nn">inspect</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

    <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">pass</span>   <span class="c1"># class based handler is being used</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

<span class="o">...</span>
</pre></div>
</td></tr></table>

<p>现在，如果正在使用基于类的处理程序，我们需要根据请求方法找到类的适当方法。为此，我们可以使用内置的<code>getattr</code>函数：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># api.py</span>

<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

    <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="n">handler_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table>

<p><code>getattr</code>接受一个对象实例作为第一个参数，将属性名称作为第二个参数。第三个参数是如果没有找到则返回的值。因此，<code>GET</code>将返回<code>get</code>，<code>POST</code>返回<code>post</code>, <code>some_other_attribute</code>返回<code>None</code>。如果<code>handler_function</code>是<code>None</code>，则表示此类函数未在类中实现，并且不允许此请求方法：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
    <span class="n">handler_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handler_function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Method not allowed&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>如果实际找到了handler_function，那么我们只需调用它：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
    <span class="n">handler_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handler_function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Method now allowed&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
    <span class="n">handler_function</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>现在整个方法看起来像这样：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

    <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="n">handler_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handler_function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Method now allowed&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="n">handler_function</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>我不喜欢我们有两个<code>handler_function</code>和<code>handler</code>。我们可以重构它们以使它更优雅：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>

    <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_handler</span><span class="p">(</span><span class="n">request_path</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">(),</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Method now allowed&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>

        <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table>

<p>就是这样。我们现在可以测试对基于类的处理程序的支持。首先，如果你还没有, 请将此处理程序添加到<code>app.py</code>：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/book&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BooksHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Books Page&quot;</span>
</pre></div>
</td></tr></table>

<p>现在，重新启动你的gunicorn并转到页面<code>http://localhost:8000/book</code>，你应该看到消息<code>Books Page</code>。就这样, 我们增加了对基于类的处理程序的支持。可以试试实现其他方法(例如<code>post</code>和<code>delete</code>)。</p>
<p>进入下一个功能！</p>
<h2 id="_3"><a class="toclink" href="#_3">单元测试</a><a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>如果没有单元测试，哪个项目是可靠的，对吧？所以让我们添加几个。我喜欢使用<code>pytest</code>，所以让我们安装它：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>pip install pytest
</pre></div>
</td></tr></table>

<p>并创建一个文件，我们将编写测试：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>touch test_bumbo.py
</pre></div>
</td></tr></table>

<p>提醒一下，<code>bumbo</code>是框架的名称。您可能以不同的方式命名。另外，如果您不知道<a href="https://docs.pytest.org/en/latest/">pytest</a>是什么，我强烈建议您查看它以了解如何编写单元测试。</p>
<p>首先，让我们为我们的<code>API</code>类创建一个我们可以在每个测试中使用的工具：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># test_bumbo.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">API</span>


<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">API</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>现在，对于我们的第一次单元测试，让我们从简单的开始。让我们测试一下我们是否可以添加路径。如果它没有抛出异常，则表示测试成功通过：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_basic_route</span><span class="p">(</span><span class="n">api</span><span class="p">):</span>
    <span class="nd">@api.route</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;YOLO&quot;</span>
</pre></div>
</td></tr></table>

<p>像这样运行测试：<code>pytest test_bumbo.py</code>你应该看到如下内容：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span>collected 1 item

test_bumbo.py .                                                                                                                                                            [100%]

====== 1 passed in 0.09 seconds ======
</pre></div>
</td></tr></table>

<p>现在，让我们测试它是否会在我们尝试添加现有路由时抛出异常：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># test_bumbo.py</span>

<span class="k">def</span> <span class="nf">test_route_overlap_throws_exception</span><span class="p">(</span><span class="n">api</span><span class="p">):</span>
    <span class="nd">@api.route</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;YOLO&quot;</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
        <span class="nd">@api.route</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">home2</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;YOLO&quot;</span>
</pre></div>
</td></tr></table>

<p>再次运行测试，您将看到它们都通过了。</p>
<p>我们可以添加更多测试，例如默认响应，参数化路由，状态代码等。但是，所有测试都要求我们向处理程序发送HTTP请求。为此，我们需要一个测试客户端。但是如果我们在这里做的话，我认为这篇文章会变得太大了。我们将在这些系列的下一篇文章中完成。我们还将添加对模板和其他一些有趣内容的支持。所以，请继续关注。</p>
<p>像往常一样，如果您想看一些功能实现，请在评论部分告诉我。</p>
<p>P.S. 这些博客文章基于我正在构建的<a href="https://github.com/rahmonov/alcazar">Python Web框架</a>。因此，<a href="https://github.com/rahmonov/alcazar">请在这儿</a>查看博客中的内容，一定要通过star该repo来表达你的喜爱。</p>
<p>Fight on!</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://www.jianshu.com/u/0f08daeaa5a9">简书</a></li>
                            <li><a href="https://weibo.com/long5to2gf">微博</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>